# Funroad üõí

## üìã Overview

Funroad is a multi‚Äëvendor e‚Äëcommerce marketplace built by following the video tutorials:

- Build and Deploy a Multi-Vendor E-Commerce Marketplace with Nextjs, React, Stripe Connect, MongoDB
  https://www.youtube.com/watch?v=6fXNWBFPfRM
- Build and Deploy a Multi Vendor E Commerce With Nextjs, React & Stripe Connect (Part 2/2)
  https://www.youtube.com/watch?v=dllIBXa0nlE&t=30657s

by @codewithantonio.

The platform allows creators to register, automatically create a store (tenant), onboard with Stripe Connect, list digital products, and sell to customers. It supports multi-tenancy (subdomain or path-based tenants), product discovery with filters, a secure checkout with platform fees, order tracking, reviews, and a customer library with access to purchased content.

## ‚ú® Features

- Authentication via Payload CMS (email/password, secure HTTP-only cookies)
- Multi-tenant stores using Payload Multi-Tenant plugin
  - Path-based routing: /tenants/[slug]
  - Optional subdomain routing: [slug].your-root-domain
- Product catalog with categories, subcategories, tags, images, and rich content
- Storefront browsing, search, filter, sort (trending, hot_and_new, curated)
- Product visibility flags: private, archived
- Reviews with rating distribution and per-user review enforcement
- Customer Library: see and access purchased products/content
- Stripe Connect checkout with platform fee and per-tenant payouts
- Stripe webhooks for order creation and account onboarding status
- File uploads (media) via Vercel Blob storage
- Admin panel auto-generated by Payload CMS with GraphQL + REST APIs
- Modern UI: Tailwind CSS components, React Query, and tRPC data layer

## üõ†Ô∏è Tech Stack

- Frontend: Next.js 15 (App Router), React 19, TypeScript, Tailwind CSS 4
- Backend: Payload CMS 3 (Next.js integration), tRPC v11, @tanstack/react-query v5
- Database: MongoDB via @payloadcms/db-mongodb (Mongoose adapter)
- Auth: Payload CMS built-in auth (users collection, HTTP-only cookie)
- Multi-tenant: @payloadcms/plugin-multi-tenant
- File storage: @payloadcms/storage-vercel-blob (Vercel Blob)
- Payments: Stripe Connect (checkout sessions, account onboarding)
- APIs: tRPC at /api/trpc, Payload REST/GraphQL routes under /(payload)/api
- Tooling: ESLint (Next + Tailwind), TypeScript strict, superjson

## üèóÔ∏è System Architecture

- App Router structure under `src/app` with route groups for auth, home, library, and tenant storefronts
- Data layer
  - tRPC server router (`src/trpc/routers/_app.ts`) composed from feature modules
  - React Query for caching and server-side prefetch/dehydration
  - superjson transformer
- Payload CMS
  - Config in `src/payload.config.ts`
  - Collections in `src/collections/*`: users, tenants, products, categories, tags, media, orders, reviews
  - MongoDB connection via `mongooseAdapter`
  - Admin UI exposed under `/(payload)/admin`
  - REST, GraphQL routes exposed under `/(payload)/api/*`
  - Vercel Blob storage for media (thumbnails/images)
- Multi-tenancy
  - Users have a tenants array field; tenant docs include slug, image, Stripe account id, details status
  - Middleware rewrites subdomains `[slug].<root-domain>` to `/tenants/[slug]`
- Payments
  - Each tenant owns a Stripe Connect account created at registration
  - Checkout session created against tenant account with application_fee_amount
  - Webhook `/api/stripe/webhooks` creates Orders and updates tenant onboarding status

Data model highlights (Payload collections):

- `users`: email, password, roles, tenants[] (auth enabled)
- `tenants`: name, slug, image, stripeAccountId, stripeDetailsSubmitted
- `products`: name, description (rich), price, category, tags[], image, refundPolicy, content (rich), isArchived, isPrivate, tenant (implicit created by plugin)
- `categories`: name, slug, color, parent, subcategories (join)
- `tags`: name, products[]
- `orders`: name, user, product, stripeCheckoutSessionId, stripeAccountId
- `reviews`: description, rating, product, user

## üì¶ Installation and Setup

1. Clone and install

```bash
git clone https://github.com/Congglee/code-with-antonio.git
cd code-with-antonio/funroad
npm install
```

2. Configure environment variables

Copy `.env.example` to `.env` (or `.env.local`) and fill in values:

```bash
# Database
DATABASE_URI=mongodb+srv://<user>:<pass>@<cluster>/<db>?retryWrites=true&w=majority

# Payload
PAYLOAD_SECRET=your-strong-random-secret

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_ROOT_DOMAIN=localhost:3000
# Optional: enable subdomain routing for tenants on production-like domains
NEXT_PUBLIC_ENABLE_SUBDOMAIN_ROUTING=true

# Stripe
STRIPE_SECRET_KEY=sk_live_or_test
STRIPE_WEBHOOK_SECRET=whsec_...

# Uploads (Vercel Blob)
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_token
```

Notes

- `PAYLOAD_SECRET` is required by Payload for session encryption.
- `BLOB_READ_WRITE_TOKEN` enables uploads via Vercel Blob; omit to disable upload features.
- `NEXT_PUBLIC_ROOT_DOMAIN` is used by the middleware for subdomain rewrites (e.g. `yourdomain.com`).
- For local dev, subdomain routing is typically disabled and path-based routing `/tenants/[slug]` is used. Client URLs respect `NEXT_PUBLIC_ENABLE_SUBDOMAIN_ROUTING`.

3. Seed the database (optional but recommended)

This will create an admin user and a category tree.

```bash
npm run db:fresh   # drops/creates collections as needed
npm run db:seed    # runs src/seed.ts (admin: admin@demo.com / demo)
```

4. Run the development server

```bash
npm run dev
```

5. Configure Stripe webhook

- Point Stripe to: `POST /api/stripe/webhooks`
- Set `STRIPE_WEBHOOK_SECRET` to the signing secret from the endpoint
- Use Stripe CLI during local development to forward events

6. Access the admin

- Payload Admin: `http://localhost:3000/admin`

## üöÄ Usage

Basic flow

1. Sign up at `/sign-up` to create an account. Registration automatically:
   - Creates a Stripe Connect account and a `tenant` with your username as slug
   - Logs you in and sets an HTTP-only cookie
2. Onboard to Stripe at `/stripe-verify` (will redirect to Stripe account onboarding). After successful onboarding, you can create products.
3. Create products via the Payload Admin or feature UIs.
4. Browse products on `/` or a specific tenant at `/tenants/[slug]`, filter by category/tags, and open product details.
5. Purchase via tenant checkout. Orders appear in your Library `/library`, where you can access protected product content.

Demo credentials (from seed)

- Email: `admin@demo.com`
- Password: `demo`

## üîç Key Features in Detail

Authentication & Authorization

- Payload handles auth, sessions via secure cookies
- `protectedProcedure` guards tRPC endpoints using `ctx.payload.auth()`
- `isSuperAdmin` utility gates admin actions (create/delete/updates on sensitive collections)

Multi-Tenant Model

- `@payloadcms/plugin-multi-tenant` adds a tenants array to users and associates documents with tenants
- Subdomain middleware rewrites `[slug].<root-domain>` to `/tenants/[slug]` without changing client routes

Catalog & Discovery

- Cursor-based pagination and server-side filters in `products.getMany`
- Category tree with parent/subcategory joins; tag filtering
- Sorting modes (trending, hot_and_new, curated)

Checkout & Orders

- Stripe Connect Checkout created in the seller‚Äôs account context with `application_fee_amount` = 10% (see `PLATFORM_FEE_PERCENTAGE`)
- Webhook creates `orders` and updates `tenants.stripeDetailsSubmitted` on `account.updated`

Reviews

- One review per user/product enforced on the server
- Rating distribution and aggregate rating computed on read

Storage

- Media stored via Vercel Blob with Payload‚Äôs storage plugin

APIs

- tRPC mounted at `/api/trpc` with superjson transformer and React Query integration
- Payload REST and GraphQL under `/(payload)/api/*`

## üßë‚Äçüíª Development

### Available Scripts

- `npm run dev` ‚Äî start Next.js in development with Payload
- `npm run build` ‚Äî build the Next.js app
- `npm run start` ‚Äî start the production build
- `npm run lint` ‚Äî run ESLint
- `npm run generate:types` ‚Äî generate `src/payload-types.ts` from config
- `npm run db:fresh` ‚Äî reset Payload collections (destructive in dev)
- `npm run db:seed` ‚Äî seed initial data (admin user + categories)

### Database Management

- MongoDB connection string in `DATABASE_URI`
- Collections and indexes are managed by Payload; no manual migrations are required
- Use `db:fresh` to reset schema and `db:seed` to load starter data

Local testing tips

- To test webhooks locally, use the Stripe CLI to forward events to `http://localhost:3000/api/stripe/webhooks`
- If testing subdomains locally, consider hosts file or a wildcard domain service; otherwise rely on path-based `/tenants/[slug]`

## ü§ù Contributing

Contributions are welcome. Please:

- Create feature branches from `main` (e.g., `feat/product-variants`, `fix/checkout-error`)
- Keep commits small and descriptive; follow conventional commit style when possible
- Run `npm run lint` and ensure type checks pass
- Open a Pull Request with a clear description and, if relevant, screenshots or steps to reproduce

Coding conventions

- TypeScript, React function components with hooks
- Keep server logic in tRPC procedures and Payload hooks; client data via React Query and tRPC
- UI components under `src/components` and feature modules under `src/modules/*`
